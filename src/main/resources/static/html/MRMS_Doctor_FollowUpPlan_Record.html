<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>随访记录</title>
    <link href="../css/bootstrap-combined.min.css" rel="stylesheet" type="text/css">
    <link href="../css/layoutit.css" rel="stylesheet" type="text/css">
    <link href="../css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <script src="../js/jquery-2.0.0.min.js"></script>
    <script src="../js/jquery-ui.js"></script>
    <script src="../js/jquery.htmlClean.js"></script>
    <script src="../js/bootstrap.min.js"></script>
    <script src="../js/custom-doctor-method.js"></script>
    <script src="../js/base-method.js"></script>

</head>
<body style="margin: 0px;">
<div class="navbar navbar-inverse">
    <div class="navbar-inner">
        <div class="container-fluid">
            <a data-target=".navbar-responsive-collapse" data-toggle="collapse" class="btn btn-navbar"><span
                    class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></a>
            <a id="home_page" href="../html/MRMS_Doctor.html" class="brand">康复医疗管理系统</a>
            <div class="nav-collapse collapse navbar-responsive-collapse">
                <ul class="nav">
                    <li >
                        <a href="../html/MRMS_Doctor.html">诊断</a>
                    </li>
                    <li class="active">
                        <a href="../html/MRMS_Doctor_FollowUpPlan_Record.html">随访记录</a>
                    </li>
                    <li class="dropdown">
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">康复管理<strong class="caret"></strong></a>
                        <ul class="dropdown-menu">
                            <li >
                                <a href="../html/MRMS_Doctor_Recover_Assessment.html">康复评定</a>
                            </li>
                            <li>
                                <a href="../html/MRMS_Doctor_Assess_Patient_Recovery.html">康复评定记录</a>
                            </li>

                        </ul>
                    </li>
                </ul>
                <ul class="nav pull-right">
                    <li class="divider-vertical">
                        <div class="btn-group">
                            <button id="user-name" class="btn" ></button>
                            <button data-toggle="dropdown" class="btn dropdown-toggle"><span class="caret"></span></button>
                            <ul class="dropdown-menu psersonal_list" >
                                <li data-id="personal_set">
                                    <a href="../html/MRMS_Personal_Center.html" onclick="setPersonalHomePage($('#home_page').attr('href'))">个人设置</a>
                                </li>
                                <li >
                                    <a href="/signOut">退出</a>
                                </li>
                                <li class="divider"></li>
                            </ul>
                        </div>
                    </li>

                </ul>
            </div></div>
    </div>

</div>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12">
            <div class="row-fluid">
                <div class="span12">
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="row-fluid">
                                <div class="span8">
                                    <h3>
                                        添加随访记录
                                    </h3>
                                    <form id="add_followUpPlan">
                                        <table id="followupplan_info" class="table ">
                                            <tbody>
                                            <tr>
                                                <td>随访计划编号</td>
                                                <td><input id="flupplanId" style="width:150px" type="text"
                                                           name="followUpId" readonly="readonly">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>患者姓名</td>
                                                <td><input id="patient_name" style="width:150px" type="text"
                                                           name="patientName" readonly="readonly">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>随访方式</td>
                                                <td>
                                                    <input name="followUpMode" type="radio" value="1">出院随访
                                                    <input name="followUpMode" type="radio" value="2">电话随访
                                                    <input name="followUpMode" type="radio" value="3">短信随访
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>治疗效果</td>
                                                <td>
                                                    <input name="treatEffect" type="radio" value="1">非常差
                                                    <input name="treatEffect" type="radio" value="2">较差
                                                    <input name="treatEffect" type="radio" value="3">一般
                                                    <input name="rtreatEffect" type="radio" value="4">较好
                                                    <input name="treatEffect" type="radio" value="5">很好
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>恢复情况</td>
                                                <td>
                                                    <input name="recoverConditions" type="radio" value="1">非常差
                                                    <input name="recoverConditions" type="radio" value="2">较差
                                                    <input name="recoverConditions" type="radio" value="3">一般
                                                    <input name="recoverConditions" type="radio" value="4">较好
                                                    <input name="recoverConditions" type="radio" value="5">很好
                                                </td>
                                            </tr>
                                            <tr>
                                                <td>患者具体情况</td>
                                                <td><textarea id="patientSpecificConditions"
                                                              name="patientSpecificConditions"></textarea></td>
                                            </tr>
                                            <tr>
                                                <td>康复宣传指导</td>
                                                <td><textarea id="reCoverPropaganda"
                                                              name="reCoverPropaganda"></textarea></td>
                                            </tr>
                                            <tr>
                                                <td>被访问者建议</td>
                                                <td><textarea id="suggest" name="suggest"></textarea></td>
                                            </tr>
                                            <tr>
                                                <td>随访满意度</td>
                                                <td>
                                                    <input name="satisfactionDegree" type="radio" value="1">非常差
                                                    <input name="satisfactionDegree" type="radio" value="2">较差
                                                    <input name="satisfactionDegree" type="radio" value="3">一般
                                                    <input name="satisfactionDegree" type="radio" value="4">满意
                                                    <input name="satisfactionDegree" type="radio" value="5">非常满意
                                                </td>
                                            </tr>

                                            </tbody>
                                        </table>
                                        <input id="patient" name="patientId" type="hidden">
                                        <input id="doctor" name="userId" type="hidden">
                                    </form>
                                    <div class="span6">
                                        <button id="success" class="btn btn-primary" onclick="setFollowUpPlanRecord($('#add_followUpPlan'))">确定</button>
                                        <input type="reset" value="重置" onclick="function resetPage() {
                                                  window.location.reload();
                                                }">
                                    </div>
                                </div>
                                <div class="span4">
                                    <div>
                                        <input type="hidden" id="digsStartTime">
                                        <input type="hidden" id="digsEndTime">
                                        <a href="#flupplan_lists" class="btn btn-primary" type="button"
                                           data-toggle="modal"
                                           onclick="findFlupplanList(1)">随访公告列表
                                        </a><br>
                                        <a href="#appoint_time_diagnosis_list" class="btn btn-primary"
                                           type="button" data-toggle="modal"
                                           onclick="findDiagnosisByTime($('#digsStartTime').val(),$('#digsEndTime').val(),1)">病人设置
                                        </a>
                                    </div>
                                    <br>
                                    <br>
                                    <div>
                                        <form id="diagnosis_record">
                                            <table class="table table-condensed">
                                                <tr>
                                                    <td>患者编号：</td>
                                                    <td><p id="p_id"></p></td>
                                                    <td>
                                                        患者姓名：
                                                    </td>
                                                    <td>
                                                        <a id="p_name" style="width: 70px;height: 20px;"
                                                           href="#patient_info" role="button" class="btn"
                                                           data-toggle="modal"
                                                           onclick="setPatientInfo($('#p_id').text())"></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>医生编号：</td>
                                                    <td><p id="doc_id"></p></td>
                                                    <td>诊断医生：</td>
                                                    <td><p id="doc_name"></p></td>
                                                </tr>
                                                <tr>
                                                    <td>
                                                        病情分类：
                                                    </td>
                                                    <td><p id="sickClassification"></p></td>
                                                    <td>
                                                        病情等级：
                                                    </td>
                                                    <td><p id="sickLevel"></p></td>
                                                </tr>

                                            </table>
                                            <label>病人主诉
                                                <textarea id="chief_complain" name="chiefComplaint"
                                                          type="textarea" style="width: 500px;height: 50px;"
                                                          readonly="readonly"></textarea>
                                            </label>
                                            <label>诊断结论
                                                <textarea id="diagnosis_result" name="diagnosisResult"
                                                          type="textarea" style="width: 500px;height: 50px;"
                                                          readonly="readonly"></textarea></td>
                                            </label>
                                            <label>康复计划
                                                <textarea id="recover_plan" name="recoverPlan"
                                                          type="textarea" style="width: 500px;height: 100px;"
                                                          readonly></textarea></label>



                                        </form>
                                    </div>

                                </div>
                            </div>


                        </div>
                    </div>
                    <div class="row-fluid">
                        <div class="span12">
                            <div class="row-fluid">

                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- 诊断单详细信息 -->
            <div id="diagnosis_info" style="width: auto;z-index:8888" class="modal hide fade" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="diagnosis_detailed_info">
                        诊断单
                    </h3>
                </div>
                <div class="modal-body">
                    <table class="table table-condensed">
                        <tr>
                            <td>
                                医生编号：
                            </td>
                            <td>
                                <label id="doctor_id"></label></td>
                            <td>
                                诊断医生：
                            </td>
                            <td>
                                <label id="doctorName"></label>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                患者编号：
                            </td>
                            <td>
                                <label id="pId"></label></td>
                            <td>
                                患者姓名：
                            </td>
                            <td><label id="pName"></label>

                            </td>
                        </tr>
                        <tr>
                            <td>
                                病情分类 :
                            </td>
                            <td>
                                <label id="sick_classification"></label></td>
                            <td>
                                病情等级 :
                            </td>
                            <td>
                                <label id="sick_level"></label>
                            </td>
                        </tr>
                    </table>

                    <label>病人主诉
                        <textarea id="chiefComplain" name="chiefComplaint"
                                  type="textarea" style="width: 500px;height: 50px;"
                                  readonly="readonly"></textarea></label>

                    <label>诊断结论
                        <textarea id="diagnosisResult" name="diagnosisResult"
                                  type="textarea" style="width: 500px;height: 50px;"
                                  readonly="readonly"></textarea></label>

                    <label>康复计划
                        <textarea id="recoverPlan" name="recoverPlan"
                                  type="textarea" style="width: 500px;height: 100px;"
                                  readonly></textarea></label>
                    <input id="diagnosis" type="hidden">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" data-dismiss="modal" aria-hidden="true"
                            onclick="setDiagnosis($('#diagnosis').val())">添加
                    </button>
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>
            <!-- 随访公告列表 -->
            <div id="flupplan_lists" style="width: auto;" class="modal hide fade" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="myModalLabel">
                        随访公告信息
                    </h3>
                </div>
                <div class="modal-body">
                    <div>
                        <table class="table table-condensed">
                            <thead>
                            <th>随访计划编号</th>
                            <th>随访时间</th>
                            <th></th>
                            </thead>
                            <tbody id="flupplan_list">

                            </tbody>
                        </table>
                        <div class="pagination pagination-centered">
                            <ul id="flupplan_list_pagination">

                            </ul>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>
            <!-- 随访计划详细信息 -->
            <div id="flupplan_info" style="width: auto;" class="modal hide fade" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="flupplanModal">
                        随访计划
                    </h3>
                </div>
                <div class="modal-body">
                    <form id="update_flupplan">
                        <table id="fuplan_table"
                               class="table  ">
                            <tbody>
                            <tr>
                                <td>随访计划编号:</td>
                                <td>
                                    <p id="followUpId"></p>
                                </td>
                            <tr>
                                <td>随访时间:</td>
                                <td>
                                    <p id="followUpTime"></p>
                                </td>
                            </tr>
                            <tr>
                                <td>选择治疗时间段内的病人进行随访:</td>
                                <td>
                                    <p id="diagnosisTime"></p>
                                </td>
                            </tr>
                            <tr>
                                <td>随访计划:</td>
                                <td>
                                    <p id="fuPlan"></p>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </form>


                </div>
                <div class="modal-footer">
                    <a href="#flupplan_info" role="button" class="btn btn-primary" data-dismiss="modal"
                       aria-hidden="true"
                       onclick="setFlupplanInfo($('#followUpId').text())">添加 </a>
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>
            <!-- 指定时间内搜索到的诊断患者列表 -->
            <div id="appoint_time_diagnosis_list" style="width: auto;" class="modal hide fade" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3>
                        诊断单列表
                    </h3>
                </div>
                <div class="modal-body">
                    <table border="1">
                        <thead>
                        <tr>
                            <th>诊断单号</th>
                            <th>患者编号</th>
                            <th>患者姓名</th>
                            <th>医生编号</th>
                            <th>诊断医生</th>
                            <th>诊断结论</th>
                            <th>诊断时间</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody id="diagnosis_list_info">

                        </tbody>

                    </table>
                    <div class="pagination pagination-centered">
                        <ul id="diagnosis_list_pagination">

                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>
            <!-- 患者信息列表 -->
            <div id="patient_info" style="width: 700px;z-index:8889" class="modal hide fade" role="dialog"
                 aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3>
                        患者治疗信息
                    </h3>
                </div>
                <div class="modal-body">
                    <table class="table table-condensed">
                        <tr>
                            <td>患者编号</td>
                            <td><label id="patient_id"></label></td>

                        </tr>
                        <tr>
                            <td>姓名</td>
                            <td><label id="patientName"></label></td>
                        </tr>
                        <tr>
                            <td>性别</td>
                            <td><label id="sex"></label></td>

                        </tr>
                        <tr>
                            <td>年龄</td>
                            <td>
                                <lable id="age"></lable>
                            </td>
                        </tr>
                        <tr>
                            <td><label>民族</label></td>
                            <td><label id="nation"></label></td>

                        </tr>
                        <tr>
                            <td>籍贯</td>
                            <td>
                                <lable id="nativePlace"></lable>
                            </td>
                        </tr>

                        <tr>
                            <td><label>家庭地址</label></td>
                            <td><label id="homeAdress"></label></td>
                        </tr>
                        <tr>
                            <td><label>身份证号码</label></td>
                            <td><label id="carId"></label></td>
                        </tr>
                        <tr>
                            <td><label>联系方式</label></td>
                            <td><label id="phoneNumber"></label></td>
                        </tr>
                        <tr>
                            <td><label>出生日期</label></td>
                            <td>
                                <lable id="mpBirthday"></lable>
                            </td>
                        </tr>
                        <tr>
                            <td><label>职业</label></td>
                            <td><label id="occupation"></label></td>
                        </tr>
                        <tr>
                            <td><label>单位</label></td>
                            <td><label id="workPlace"></label></td>
                        </tr>
                        <tr>
                            <td><label>身高</label></td>
                            <td><label id="height"></label></td>
                        </tr>
                        <tr>
                            <td><label>体重</label></td>
                            <td><label id="weight"></label></td>
                        </tr>
                        <tr>
                            <td><label>血型</label></td>
                            <td><label id="bloodType"></label></td>
                        </tr>
                        <tr>
                            <td><label>是否存在家族病史</label></td>
                            <td><label id="famSickHistroy"></label></td>
                        </tr>
                        <tr>
                            <td><label>家族病史说明</label></td>
                            <td>
                                <lable id="sickHistrionicInstruction"></lable>
                            </td>
                        </tr>
                        <tr>
                            <td><label>是否药物过敏</label></td>
                            <td>
                                <lable id="drugAllergy"></lable>
                            </td>
                        </tr>
                        <tr>
                            <td><label>药物过敏说明</label></td>
                            <td>
                                <lable id="drugAllergyIntroduction"></lable>
                            </td>
                        </tr>
                    </table>


                </div>
                <div class="modal-footer">
                    <button class="btn" data-dismiss="modal" aria-hidden="true">关闭</button>
                </div>
            </div>

        </div>
    </div>
</div>
</body>
<script type="text/javascript">

    $(document).ready(function (ev) {
        var homePage = getCookie("href");
        var userName = getCookie("userName");
        console.log(homePage + " " + userName);
        $("#user-name").html(userName);
        $("#home_page").attr("href", homePage);
        findFlupplanList(1);
    });

    //添加随访记录
    function setFollowUpPlanRecord(form) {
        $.ajax({
            type: "post",
            url: "/addFollowUpPlan",
            data:form.serialize(),
            success : function (result) {
                if (result === true){
                    alert("添加成功！");
                    window.location.reload();
                }
                else{
                    alert("添加记录失败，请检查输入数据是否正确！");
                }
            }
        })
    }
    //设置随访计划列表
    function findFlupplanList(pageNum) {
        $.ajax({
            type: "get",
            url: "/findFlupplanList",
            data: {
                pageNum: pageNum,
                pageSize: 5
            },
            dataType: "json",
            success: function (map) {
                console.log(map.flupplans);
                $("#flupplan_list").html("");
                $("#flupplan_list_pagination").html("");
                var tbody = "";

                $.each(map.flupplans.list, function (i, flupplan) {
                    var releaseDate = timestampToDate(flupplan.releaseDate);
                    tbody += '<tr id=' + '"' + flupplan.followUpId + '"' + '><td>' + flupplan.followUpId + '</td><td>' + releaseDate
                        + '</td><td><a href="#flupplan_info" role="button" class=" btn btn-primary" data-toggle="modal"' +
                        'onclick="findFlupplans(' + "'" + flupplan.followUpId + "'" + ')">详细信息</a>'
                        + '<a href="#flupplan_info" role="button" class="btn btn-primary"  data-dismiss="modal" aria-hidden="true"' +
                        'onclick="setFlupplanInfo(' + "'" + flupplan.followUpId + "'" + ')">√ </a></td></tr>';
                });

                var page = map.flupplans;
                var pageBody = pagination(page, "flupplans");
                $("#flupplan_list_pagination").append(pageBody);
                $("#flupplan_list").append(tbody);

            },
            error: function () {
                alert("找不到该挂号单");
                return;
            }
        })
    }


    //根据随访计划ID寻找随访计划的详细信息
    function findFlupplans(followUpId) {

        $.ajax({
            url: "/findFlupplanById",
            type: "get",
            data: {
                followUpId: followUpId
            },
            success: function (flupplan) {
                console.log(flupplan);
                $("#followUpId").text(flupplan.followUpId);
                $("#diagnosisTime").text(timestampToDate(flupplan.digsStartTime) + "   至   " + timestampToDate(flupplan.digsEndTime));
                $("#followUpTime").text(timestampToDate(flupplan.fuStartTime) + "   至   " + timestampToDate(flupplan.fuEndTime));
                $("#fuPlan").text(flupplan.fuPlan);
            },
            error: function () {

            }
        });

    }

    //在随访记录表中设置随访计划编号和需要寻访的病人时间
    function setFlupplanInfo(followUpId) {
        $.ajax({
            url: "/findFlupplanById",
            type: "get",
            data: {
                followUpId: followUpId
            },
            success: function (flupplan) {
                console.log(flupplan);
                $("#flupplanId").val(flupplan.followUpId);
                $("#digsStartTime").val(timestampToDate(flupplan.digsStartTime));
                $("#digsEndTime").val(timestampToDate(flupplan.digsEndTime));
                $("#flupplan_lists").modal("hide");
            },
            error: function () {

            }
        });
    }


    //自定义分页插件--病人诊断单信息
    function pagination(page, name, startDate, endDate) {
        var pageBody = "";
        pageBody += '<li><a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',1,' + startDate + ',' + "'" + endDate + "'" + ')" >首页</a></li>';
        if (page.pageNum != 1)
            pageBody += '<li> <a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pageNum - 1) + ',' + startDate + ',' + "'" + endDate + "'" + ')">上一页</a></li>';
        //假如总页数只有1页时，不设置分页
        //当总页数少于7时，显示所有的页数，否则动态变换
        var al = '';
        if (page.pages < 7) {
            for (var i = 1; i <= page.pages; i++) {
                if (i == page.pageNum)
                    pageBody += '<li class="active"><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
                else
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
            }
        } else {
            if (page.pageNum - 3 < 1) {
                for (var i = 1; i < page.pageNum; i++) {
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
                }
            } else {
                pageBody += '<li> <a  href="javascript:;" >...</a></li>';
                for (var i = page.pageNum - 3; i < page.pageNum; i++) {
                    pageBody += '<li> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
                }
            }
            //高亮当前页面
            pageBody += '<li class="active"> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';

            if (page.pageNum + 4 > page.pages) {
                for (var i = page.pageNum + 1; i <= page.pages; i++) {
                    pageBody += '<li> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
                }
            } else {
                for (var i = page.pageNum + 1; i < page.pageNum + 4; i++) {
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ',' + startDate + ',' + "'" + endDate + "'" + ')">' + i + '</a></li>';
                }
                pageBody += '<li> <a  href="javascript:;" >...</a></li>';
            }

        }

        if (page.pageNum != page.pages)
            pageBody += '<li> <a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pageNum + 1) + ',' + startDate + ',' + "'" + endDate + "'" + ')">下一页</a></li>';
        pageBody += '<li><a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pages) + ',' + startDate + ',' + "'" + endDate + "'" + ')">尾页</a></li>';
        pageBody += '<li><input type="text"  style="width: 40px; " id="pageNumberGo" oninput = "value=value.replace(/[^\\d]/g,' + "'" + "'" + ')">页</li>';
        pageBody += '<li><a href="javascript:;" onclick="pagejumping(' + "'" + name + "'" + ',' + startDate + ',' + "'" + endDate + "'" + ',' + page.pages + ')">跳转</a></li>';
        pageBody += '<li>&nbsp;&nbsp;&nbsp;&nbsp;共' + page.pageNum + '/' + page.pages + '页&nbsp;&nbsp;&nbsp;&nbsp;</li>';

        return pageBody;
    }

    //自定义分页插件--随访公告专用
    function pagination(page, name) {
        var pageBody = "";
        pageBody += '<li><a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',1,' + ')" >首页</a></li>';
        if (page.pageNum != 1)
            pageBody += '<li> <a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pageNum - 1) + ')">上一页</a></li>';
        //假如总页数只有1页时，不设置分页
        //当总页数少于7时，显示所有的页数，否则动态变换
        var al = '';
        if (page.pages < 7) {
            for (var i = 1; i <= page.pages; i++) {
                if (i == page.pageNum)
                    pageBody += '<li class="active"><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
                else
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
            }
        } else {
            if (page.pageNum - 3 < 1) {
                for (var i = 1; i < page.pageNum; i++) {
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
                }
            } else {
                pageBody += '<li> <a  href="javascript:;" >...</a></li>';
                for (var i = page.pageNum - 3; i < page.pageNum; i++) {
                    pageBody += '<li> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
                }
            }
            //高亮当前页面
            pageBody += '<li class="active"> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';

            if (page.pageNum + 4 > page.pages) {
                for (var i = page.pageNum + 1; i <= page.pages; i++) {
                    pageBody += '<li> <a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
                }
            } else {
                for (var i = page.pageNum + 1; i < page.pageNum + 4; i++) {
                    pageBody += '<li><a  href="javascript:;"  onclick="clickpage(' + "'" + name + "'" + ',' + i + ')">' + i + '</a></li>';
                }
                pageBody += '<li> <a  href="javascript:;" >...</a></li>';
            }

        }

        if (page.pageNum != page.pages)
            pageBody += '<li> <a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pageNum + 1) + ')">下一页</a></li>';
        pageBody += '<li><a href="javascript:;" onclick="clickpage(' + "'" + name + "'" + ',' + (page.pages) + ')">尾页</a></li>';
        pageBody += '<li><input type="text"  style="width: 40px; " id="pageNumberGo" oninput = "value=value.replace(/[^\\d]/g,' + "'" + "'" + ')">页</li>';
        pageBody += '<li><a href="javascript:;" onclick="pagejumping(' + "'" + name + "'," + page.pages + ')">跳转</a></li>';
        pageBody += '<li>&nbsp;&nbsp;&nbsp;&nbsp;共' + page.pageNum + '/' + page.pages + '页&nbsp;&nbsp;&nbsp;&nbsp;</li>';

        return pageBody;
    }

    //根据条件点击页码跳转
    function clickpage(name, number, value1, value2) {

        if (name === "flupplans")
            findFlupplanList(number);
        if (name === "diagnosis")
            findDiagnosisByTime(value1, value2, number);

    }

    //根据输入的页数跳转
    function pagejumping(name, maxPages, value1, value2) {
        var number = $("#pageNumberGo").val();
        if (number == null || number == "") {
            alert("请输入跳转页数");
            return false;
        } else if (number > maxPages) {
            alert("当前输入的页码已超过最大页码");
            return false;
        }
        if (name === "flupplans")
            clickpage(name, number);
        if (name === "diagnosis")
            findDiagnosisByTime(value1, value2, number);
    }

    //判断开始时间是否少于结束时间
    function checkDateTime(dateStartTime, dateEndTime) {
        if (dateStartTime === "" || dateStartTime == null)
            return false;
        if (dateEndTime === "" || dateEndTime == null)
            return false;


        var startTime = dateStartTime;
        var start = new Date(startTime.replace("-", "/").replace("-", "/"));
        var endTime = dateEndTime;
        var end = new Date(endTime.replace("-", "/").replace("-", "/"));
        if (end < start) {
            alert("开始时间不能小于结束时间");
            return false;
        } else
            return true;
    }

    //寻找指定时间内诊断的患者
    function findDiagnosisByTime(dateStartTime, dateEndTime, pageNum) {
        console.log(dateStartTime + "  " + dateEndTime);
        var flag = checkDateTime(dateStartTime, dateEndTime);
        if (flag === false)
            return;
        var doctorId = getCookie("userId");
        $.ajax({
            type: "get",
            url: "/getAppointTimeDiagnosis",
            data: {
                doctorId: doctorId,
                startDate: dateStartTime,
                endDate: dateEndTime,
                pageNum: pageNum,
                pageSize: 5
            },
            dataType: "json",
            success: function (map) {
                console.log(map.diagnosises);
                $("#diagnosis_list_info").html("");
                $("#diagnosis_list_pagination").html("");
                var tbody = "";

                $.each(map.diagnosises.list, function (i, diagnosis) {
                    var diagnosisDateTime = timestampToTime(diagnosis.diagnosisDate);
                    tbody += '<tr id=' + '"' + diagnosis.diagnosisId + '"' + '><td>' + diagnosis.diagnosisId + '</td><td>' + diagnosis.patient.patientId
                        + '</td><td>' + diagnosis.patient.patientName + '</td><td>' + diagnosis.doctor.userId + '</td><td>' + diagnosis.doctor.userName
                        + '</td><td>' + diagnosis.diagnosisResult + '</td><td>' + diagnosisDateTime
                        + '</td><td><a href="#diagnosis_info" role="button" class=" btn btn-primary" data-toggle="modal"' +
                        'onclick="findDiagnosisByDiagnosisId(' + "'" + diagnosis.diagnosisId + "'" + ')">详细信息</a>'
                        + '<a href="#" role="button" class=" btn btn-warning" data-toggle="modal" data-dismiss="modal"' +
                        'onclick="setDiagnosis(' + "'" + diagnosis.diagnosisId + "'" + ')">添加</a></td></tr>';
                });

                var page = map.diagnosises;
                var pageBody = pagination(page, "register");
                $("#diagnosis_list_pagination").append(pageBody);
                $("#diagnosis_list_info").append(tbody);

            },
            error: function () {

                return false;
            }
        })

    }

    //设置病人信息
    function setPatientInfo(patientId) {
        if (patientId == null)
            return;
        $.ajax({
            type: "get",
            url: "/searchAppointedPatient",
            data: {patientId: patientId},
            dataType: "json",
            success: function (patient) {
                $("#patient_id").text(patient.patientId);
                $("#pName").text(patient.patientName);
                $("#patientId").text(patient.patientId);
                $("#patientName").text(patient.patientName);
                $("#age").text(patient.age + "岁");
                $("#sex").text(patient.sex == true ? "男" : "女");
                $("#nation").text(patient.nation);
                $("#nativePlace").text(patient.nativePlace);
                $("#carId").text(patient.carId);
                $("#homeAdress").text(patient.homeAdress);
                $("#phoneNumber").text(patient.phoneNumber);
                var birthday = timestampToDate(patient.mpBirthday);//生日需要转换
                $("#mpBirthday").text(birthday);
                $("#occupation").text(patient.occupation);
                $("#workPlace").text(patient.workPlace);
                $("#height").text(patient.height + " cm");
                $("#weight").text(patient.weight + " kg");
                $("#bloodType").text(patient.bloodType + " 型");
                $("#famSickHistroy").text(patient.famSickHistroy == true ? "是" : "否");
                $("#sickHistrionicInstruction").text(patient.famSickHistroy == true ? patient.sickHistrionicInstruction : "");
                $("#drugAllergy").text(patient.drugAllergy == true ? "是" : "否");
                $("#drugAllergyIntroduction").text(patient.drugAllergy == true ? patient.drugAllergyIntroduction : "");
            }
        })
    }

    //查找并在遮罩层中设置诊断记录信息
    function findDiagnosisByDiagnosisId(diagnosisId) {
        console.log(diagnosisId);
        if (diagnosisId == null || diagnosisId == "")
            return;

        $.ajax({
            type: "get",
            url: "/findDiagnosisById",
            dataType: "json",
            data: {"diagnosisId": diagnosisId},
            success: function (map) {

                console.log(map.diagnosis);
                var diagnosis = map.diagnosis;
                //设置表单信息
                $("#diagnosis").val(diagnosis.diagnosisId);
                $("#doctor_id").text(diagnosis.doctor.userId);
                $("#doctorName").text(diagnosis.doctor.userName);
                $("#pId").text(diagnosis.patient.patientId);
                $("#pName").text(diagnosis.patient.patientName);
                $("#sick_classification").text(diagnosis.sickClassification);
                $("#sick_level").text(diagnosis.sickLevel);
                $("#chiefComplain").text(diagnosis.chiefComplaint);    //病因
                $("#diagnosisResult").text(diagnosis.diagnosisResult); //诊断结果
                $("#recoverPlan").text(diagnosis.recoverPlan);             //康复计划

            },
            error: function () {
                alert("找不到该诊断信息表，请检查输入是否正确");

            }
        })

    }

    //设置诊断记录信息
    function setDiagnosis(diagnosisId) {
        console.log(diagnosisId);
        if (diagnosisId == null || diagnosisId == "")
            return;

        $.ajax({
            type: "get",
            url: "/findDiagnosisById",
            dataType: "json",
            data: {"diagnosisId": diagnosisId},
            success: function (map) {
                var diagnosis = map.diagnosis;
                //设置表单信息
                $("#doc_id").text(diagnosis.doctor.userId);
                $("#doc_name").text(diagnosis.doctor.userName);
                $("#p_id").text(diagnosis.patient.patientId);
                $("#p_name").text(diagnosis.patient.patientName);
                $("#sickClassification").text(diagnosis.sickClassification);
                $("#sickLevel").text(diagnosis.sickLevel);
                $("#chief_complain").text(diagnosis.chiefComplaint);    //病因
                $("#diagnosis_result").text(diagnosis.diagnosisResult); //诊断结果
                $("#recover_plan").text(diagnosis.recoverPlan);             //康复计划

                $("#appoint_time_diagnosis_list").modal("hide");

                $("#patient").val(diagnosis.patient.patientId);
                $("#doctor").val(diagnosis.doctor.userId);
                $("#patient_name").val(diagnosis.patient.patientName);
            },
            error: function () {


            }
        })

    }
</script>
</html>